<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/layout :: layout(~{ :: body}, 'Lotto')}">
<body>
<form id="lotto" name="lotto" th:action="@{/lotto-detail/} + ${user.id}" method="post">
  <div class="card" th:object="${user}">
    <div class="card-header bg-info text-white" th:text="${user.name}"></div>
    <div class="card-body">
      <table id="tbDetail" class="table table-bordered table-responsive-sm">
        <thead>
        <tr>
          <th scope="col" style="width: 20%">ตัวเลข</th>
          <th scope="col" style="width: 20%">บน</th>
          <th scope="col" style="width: 20%">ล่าง</th>
          <th scope="col" style="width: 20%">โต๊ด</th>
          <th scope="col" style="width: 20%">จำนวนเงิน</th>
        </tr>
        </thead>
        <tr id="trDetail" th:each="lotto : ${user.lottos}">
          <td>
            <input type="number" class="form-control" th:name="numberLotto + ${lotto.id}" th:value="${lotto.numberLotto}" onblur="setInputTote(this);checkLength(this)">
          </td>
          <td>
            <input type="number" class="form-control" th:name="buyOn + ${lotto.id}" th:value="${lotto.buyOn}" onblur="calRow(this)">
            <input type="hidden" th:name="lottoId + ${lotto.id}" th:value="${lotto.id}">
          </td>
          <td><input type="number" class="form-control" th:name="buyDown + ${lotto.id}" th:value="${lotto.buyDown}" onblur="calRow(this)"></td>
          <td th:switch="${lotto.numberLotto.length()}">
            <span th:case="'3'"><input type="number" class="form-control" th:name="buyTote + ${lotto.id}" th:value="${lotto.buyTote}" onblur="calRow(this)"></span>
            <span th:case="*"><input type="number" class="form-control" th:name="buyTote + ${lotto.id}" th:value="${lotto.buyTote}" readonly></span>
          </td>
          <td><input type="text" class="form-control" th:name="buyTotal + ${lotto.id}" th:value="${lotto.buyTotal}" readonly></td>
        </tr>
      </table>
      <table class="table table-bordered table-responsive-sm">
        <tr>
          <td style="width: 80%" class="text-right">รวม</td>
          <td><input type="text" class="form-control" id="buyAll" name="buyAll" th:value="${user.buy}" readonly></td>
        </tr>
      </table>
    </div>
  </div>
  <br/>
  <input type="hidden" id="maxId" name="maxId" th:value="${maxId}"/>
  <button type="button" class="btn btn-primary" onclick="addRow()">สร้างเลข</button>
  <button type="button" class="btn btn-primary" onclick="save()">บันทึก</button>
  <input type="hidden" id="detail" name="detail">
  <input type="hidden" id="line" name="line">
</form>
<script>

  function addRow() {
    let num = Number($('#maxId').val());
    addRow = function() {
      num++;
      $('#tbDetail').append('<tr>' +
        '<td><input type="number" class="form-control" name="numberLotto' + num + '" onblur="setInputTote(this);checkLength(this)"></td>' +
        '<td><input type="number" class="form-control" name="buyOn' + num + '" value="0" onblur="calRow(this)"></td>' +
        '<td><input type="number" class="form-control" name="buyDown' + num + '" value="0" onblur="calRow(this)"></td>' +
        '<td><input type="number" class="form-control" name="buyTote' + num + '" value="0" onblur="calRow(this)" readonly></td>' +
        '<td><input type="text" class="form-control" name="buyTotal' + num + '" value="0" readonly></td>' +
        '</tr>');
      chkInteger();
    };
    addRow();
  }

  function save() {
    $("#detail").val($("form").serialize());
    let arr = [];
    $('#tbDetail').find('tr').not('tr:eq(0)').each(function () {
      let name = $(this).find('td:eq(0)').find('input[name^="numberLotto"]').attr('name');
      let line = name.slice(11);
      arr.push(line);
    });
    $('#line').val(arr.join());
    $('#lotto').submit();
  }

  function deleteUser(name, field) {
    if (confirm('คุณต้องการลบรายชื่อ ' + name + ' ใช่หรือไม่')) {
      jQuery(field).closest('form').submit();
    }
  }

  function chkInteger() {
    $("input[type='number']").keydown(function (e) {
      const keycode = e.keyCode;
      if (keycode === 69 || keycode === 107 || keycode === 109 || e.key === '-') {
        e.preventDefault();
      }
    });
  }

  function setInputTote(e) {
    const $field = jQuery(e);
    let $tote = $field.closest('tr').find("input[type='number'][name^='buyTote']");
    if (e.value.length === 3) {
      $tote.prop('readonly', false);
    } else {
      $tote.prop('readonly', true).val(0);
    }
  }

  function checkLength(e) {
    if (e.value.length > 3) {
      e.value = e.value.substr(0, 3);
    }
  }

  function calRow(e) {
    const $field = jQuery(e);
    const $tr = $field.closest('tr');
    let buyOn = Number($tr.find("input[type='number'][name^='buyOn']").val());
    let buyDown = Number($tr.find("input[type='number'][name^='buyDown']").val());
    let buyTote = Number($tr.find("input[type='number'][name^='buyTote']").val());
    let buyTotal = buyOn + buyDown + buyTote;
    $tr.find("input[type='text'][name^='buyTotal']").val(buyTotal);
    calAll();
  }

  function calAll() {
    let num = 0;
    $("input[type='text'][name^='buyTotal']").each(function () {
      num += Number($(this).val());
    });
    $('#buyAll').val(num);
  }

  $(function () {
    chkInteger();
    if ($('#tbDetail').find('tr').length === 1) {
      addRow();
    }
  });

</script>
</body>
</html>